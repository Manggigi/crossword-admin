<!-- 92296f51-b41e-45ac-80b7-f95742cf8de7 48c8e17e-0290-4ef2-a3af-f1b4aa41384e -->
# Public API v1 Parity (Consumer-ready)

## Goals

- Deliver a versioned, consumer-grade `/api/v1` with shapes matching the Ruby appâ€™s Swagger (in `crossword-admin-ruby/swagger`).
- Keep Admin CMS working as-is; add public endpoints for web/iOS consumers.
- Add performance basics: pagination, ETag/Cache-Control, and consistent error format.

## Decisions (best judgment)

- Exact contract parity for response shapes (puzzle_compact, puzzle_expanded, group, collection, game_session, session_hint, hint, share).
- Version paths under `/api/v1/*` and keep `/api/*` for admin-internal as needed.
- JWT Bearer for player endpoints; CORS enabled for consumer apps.
- Hints: stub deterministic output now; OpenAI integration in a later sprint.
- DB: Store `game_sessions`, `session_hints`, `shares` in D1.
- Tests: Expand the existing E2E runner to cover new endpoints and schemas.

## Deliverables

- D1 migrations for `game_sessions`, `session_hints`, `shares`.
- `/api/v1` routes: groups, collections, puzzles (daily/themed/training + show), players (sign_in/sign_up/guest/profile), game_sessions (create/get/patch), session_hints (create), hints (get), shares (create).
- Zod schemas and OpenAPI for all above; docs visible in `/api-docs`.
- E2E tests covering happy paths; CI script to run tests locally.
- CORS + pagination + ETag/Cache-Control on safe GETs; consistent error shape.

## Steps

1) Versioning & CORS

- Add `/api/v1` prefix and CORS middleware: allow origins env-based, methods, credentials as needed.
- Keep existing admin routes under `/api`.

2) Schemas (Zod) from Ruby Swagger

- Import Ruby Swagger YAML, map to TS Zod: `group`, `collection`, `puzzle_compact`, `puzzle_expanded`, `game_session`, `session_hint`, `hint`, `share`.
- Centralize in `server/schemas/v1.ts` and export OpenAPI.

3) DB migrations (D1)

- `game_sessions`: id, puzzle_id, player_id|null, status, data(json), created_at, updated_at.
- `session_hints`: id, game_session_id, payload(json), created_at.
- `shares`: id, puzzle_id, player_id|null, channel, created_at.

4) Public API routes `/api/v1/*`

- Groups: `GET /groups`, `GET /groups/{id}` (optional), `GET /groups/{id}/collections`.
- Collections: `GET /collections/{id}`.
- Puzzles: `GET /puzzles/daily`, `GET /puzzles/training`, `GET /puzzles/themed`, `GET /puzzles/{id}` (expanded shape).
- Players: `POST /players/sign_in`, `POST /players/sign_up`, `POST /players/guest/sign_up`, `GET /players/profile`.
- Game sessions: `POST /puzzles/{id}/game_sessions` (create), `GET /game_sessions/{id}`, `PATCH /game_sessions/{id}`.
- Session hints: `POST /game_sessions/{id}/session_hints`.
- Hints: `GET /puzzles/{id}/hints` (stubbed deterministic payload for now).
- Shares: `POST /puzzles/{id}/shares`.

5) Pagination & caching

- Add `?page`/`?per_page` for list endpoints.
- ETag based on rows/version; `Cache-Control: public, max-age=60` for public lists; `private, max-age=0` for player-scoped endpoints.

6) Error format & guards

- Standard JSON error: `{ error: string, code?: string }` with appropriate 4xx/5xx.
- Middleware for Bearer JWT on player routes; cookie admin remains separate.

7) Docs & E2E

- Register all schemas/routes with OpenAPIHono; ensure `/api-docs` shows full v1 set.
- Expand `scripts/e2e.mjs`: smoke tests for each route including create session, add session_hint, get hints, share.
- Add CI script to run E2E.

## Out-of-scope (next sprint)

- OpenAI integration for hints.
- R2 uploads for icons and puzzle assets.
- Rate limiting & analytics dashboards.
- Themed/business flows not present in Swagger.

### To-dos

- [ ] Add /api/v1 prefix and CORS middleware
- [ ] Map Ruby Swagger schemas to Zod in server/schemas/v1.ts
- [ ] Add game_sessions, session_hints, shares tables in D1
- [ ] Implement /api/v1/groups and /groups/{id}/collections
- [ ] Implement /api/v1/collections/{id}
- [ ] Implement /api/v1/puzzles/daily|training|themed
- [ ] Implement /api/v1/puzzles/{id} expanded shape
- [ ] Implement /api/v1/players sign_in|sign_up|guest|profile
- [ ] Implement /api/v1/puzzles/{id}/game_sessions and GET/PATCH game_sessions/{id}
- [ ] Implement /api/v1/game_sessions/{id}/session_hints create
- [ ] Implement /api/v1/puzzles/{id}/hints (stubbed)
- [ ] Implement /api/v1/puzzles/{id}/shares create
- [ ] Add pagination and ETag/Cache-Control to list endpoints
- [ ] Adopt consistent JSON error shape across v1
- [ ] Expose full OpenAPI for v1 routes
- [ ] Expand scripts/e2e.mjs to cover v1 endpoints
- [ ] Add CI script to run E2E locally