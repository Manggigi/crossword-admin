<!-- 92296f51-b41e-45ac-80b7-f95742cf8de7 76b8db47-7311-4bf2-a9f6-3a68b177cf9c -->
# Parity Sprint 1 – Admin basics, auth hardening, and API coverage

## Preconditions (quick fixes)

- Change D1 binding name to `DB` in `wrangler.jsonc` (currently `crossword_admin_dev`) so `getDb(env)` works without code changes.
- Move `JWT_SECRET` to Wrangler secret:
- `wrangler secret put JWT_SECRET` (then remove inline value from `vars` later)

## Scope for this sprint (today)

- Harden auth: password hashing; cookie/Bearer unchanged.
- Expand data shape minimally to support admin puzzle CRUD + publish.
- Cover Groups/Collections API (list/show) to match Rails shape where practical.
- Build Admin UI: nav shell + puzzles list/create/edit/publish.
- Document endpoints with zod/OpenAPI schemas (puzzles + auth + groups/collections).

## Deliverables

- Admin can log in, view puzzles, create/edit a puzzle, and toggle publish.
- Groups/Collections endpoints and admin pages present basic lists.
- `/openapi.json` reflects real schemas; `/api-docs` renders via CDN.

## Steps

### 1) Auth hardening

- Add password hashing (bcryptjs or scrypt) in:
- `server/routes/adminAuth.ts` and `server/routes/playerAuth.ts`
- Update seeds to store hashed password for `admin@example.com`.
- Keep token lifetimes the same (1h); no refresh yet.

### 2) Data model adjustments (D1)

- Add columns required for basic editing:
- `puzzles`: `description` (TEXT), `difficulty` (TEXT), optional `published_at` (INTEGER ms)
- Optional FK indexes for `groups`/`collections` convenience.
- Create `drizzle/0003_alter_puzzles.sql` migration and apply.

### 3) Groups/Collections API (Hono + Drizzle)

- New routes `server/routes/groups.ts` and `collections.ts`:
- `GET /api/groups` → list (id, name, slug)
- `GET /api/groups/:id/collections` → list by group
- `GET /api/collections/:id` → show
- Add zod schemas and register with OpenAPI.

### 4) Puzzles Admin API

- Extend `server/routes/puzzles.ts` for admin actions:
- `POST /api/puzzles` (title, date, description, difficulty, collectionId)
- `PUT /api/puzzles/:id`
- `POST /api/puzzles/:id/publish` (sets status=published, published_at=now)
- Protect with `requireAdmin`.
- Add zod request/response schemas and OpenAPI registrations.

### 5) Admin UI – shell + CRUD

- Layout/nav in `routes/admin.tsx` → add links: Dashboard, Groups, Collections, Daily Puzzles.
- Pages:
- `routes/admin.puzzles.new.tsx` (form → POST `/api/puzzles`)
- `routes/admin.puzzles.$id.edit.tsx` (form → PUT `/api/puzzles/:id`)
- Buttons on list row for Publish (POST publish) and Edit
- Loader/action patterns; show validation errors inline.

### 6) Docs & DX

- Attach zod schemas to OpenAPIHono so `/openapi.json` matches routes.
- Keep Swagger UI via CDN at `/api-docs`.

### 7) Nice-to-haves if time permits

- `GET /api/players/profile` (Bearer) with minimal shape.
- Pagination on lists.

## Testing & sanity checks

- After migration, run:
- `wrangler d1 migrations apply crossword_admin_dev`
- Manual flows:
- Login → /admin → create puzzle → edit → publish
- `/api/groups`, `/api/groups/:id/collections`, `/api/puzzles/daily`
- `/api-docs` renders schemas

## Notes & out-of-scope (today)

- File uploads remain deferred (use string `icon_url`).
- Game sessions and hints are out-of-scope for today; plan in next sprint.

### To-dos

- [ ] Rename D1 binding to DB in wrangler.jsonc
- [ ] Move JWT_SECRET to Wrangler secret; remove inline later
- [ ] Add password hashing and update seeds
- [ ] Add description,difficulty,published_at to puzzles
- [ ] Implement /api/groups and related endpoints
- [ ] Implement /api/collections endpoints
- [ ] Add admin puzzle create/edit/publish endpoints
- [ ] Add zod schemas and OpenAPI for new endpoints
- [ ] Add admin puzzle create/edit forms
- [ ] Add publish button in puzzles list