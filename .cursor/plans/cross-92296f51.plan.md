<!-- 92296f51-b41e-45ac-80b7-f95742cf8de7 001998c2-f179-405f-98d5-3c1bb4bf249f -->
# Crossword Admin on React Router + Hono with D1 (Initial Milestones)

## Decisions (from your answers)

- Database: Cloudflare D1 (SQLite)
- Auth milestone: Admin + Player JWT
- Admin: secure HTTP-only cookie JWT
- Player: Bearer JWT in Authorization header
- Data migration: Defer; build fresh minimal schema now
- File uploads: Not yet; stub placeholders for icons/attachments
- Deploy target: Cloudflare Workers
- API contracts/docs: Enforce schemas from day 1 with zod + OpenAPI

## Phase 0 – Foundations (tooling + bindings)

- Add D1 binding `DB` in `wrangler.jsonc` and type it in `worker-configuration.d.ts`.
- Add dependencies: drizzle-orm (D1 driver), @hono/zod-openapi, zod, jose (JWT), cookie utilities.
- Set up ESLint/Prettier if not already strict; ensure TS strict.

## Phase 1 – Data layer (minimal schema + seeds)

- Create Drizzle D1 schema for: `admin_users`, `player_users`, `groups`, `collections`, `puzzles` (minimal columns: ids, names, slugs, dates, status, icon_url placeholder).
- Generate SQL migrations compatible with D1; add seed for one admin user and a handful of daily puzzles.
- Local execution: wrangler d1 migrations/execute for dev DB.

## Phase 2 – Auth (Admin + Player)

- Add `auth/jwt.ts`: `createJwt`, `verifyJwt` with `JWT_SECRET` binding.
- Add `auth/cookies.ts`: set/clear secure HTTP-only cookie `admin_session`.
- Hono routes under `/api/admin/auth` and `/api/players/auth`:
- Admin: `POST /sign_in`, `POST /sign_out` (cookie-based), `GET /me`.
- Player: `POST /sign_in`, `POST /sign_up`, `POST /guest` (Bearer JWT), `GET /me`.
- Middleware: `requireAdmin` (cookie→JWT→admin id), `requirePlayer` (Bearer→JWT→player id).

## Phase 3 – API (first endpoints + zod/OpenAPI)

- Install and configure `@hono/zod-openapi`.
- Add OpenAPI route `/api-docs` (serve Swagger UI + JSON spec) derived from route schemas.
- Implement parity-style read endpoints (subset) with zod validation:
- `GET /api/puzzles/daily` (list latest N with date, title, icon_url placeholder)
- `GET /api/puzzles/:id` (details minimal)
- Keep shapes close to Rails responses where easy; document with zod.

## Phase 4 – Admin UI (SSR + protected pages)

- Add `/login` page: React Router form that posts to `/api/admin/auth/sign_in`; on success redirect to `/admin`.
- Add protected `/admin` layout with loader checking `admin_session` cookie (via server-side call) and redirecting to `/login` if missing.
- Add `/admin/daily/puzzles` page (SSR loader fetches from `/api/puzzles/daily`); simple table with date/title/status.
- Navigation shell for admin (header with sign out).

## Phase 5 – Quality gates

- Error handling: consistent JSON error shape from Hono; typed `Result<T>` helpers.
- Add basic integration tests for auth flows and puzzles endpoints (where feasible in Workers env).
- Wire minimal logging; keep error logs, avoid console noise.

## Files to touch (initial set)

- `wrangler.jsonc`: add D1 binding `DB` and JWT/R2 placeholders
- `worker-configuration.d.ts`: `DB: D1Database`, `JWT_SECRET: string`
- `package.json`: deps/devDeps for drizzle, zod, jose, @hono/zod-openapi
- `workers/app.ts`: mount new routes and middleware
- `app/routes.ts` + `react-router.config.ts`: add `/login`, `/admin`, `/admin/daily/puzzles`
- `app/routes/login.tsx`, `app/routes/admin.tsx`, `app/routes/admin.daily.puzzles.tsx`
- `app/app.css`: basic admin styles (minimal)
- `server/` (new): `auth/jwt.ts`, `auth/cookies.ts`, `db/schema.ts`, `db/client.ts`, `routes/*`
- `drizzle/` (new): migrations + config

## Deliverables for this iteration

- Running on Workers locally with D1: admin login works; admin-only pages redirect if unauthenticated.
- `/api/puzzles/daily` and `/api/puzzles/:id` return typed responses (zod) with OpenAPI docs at `/api-docs`.
- Admin UI shows a basic daily puzzles list (SSR loader), sign out clears cookie.

## Notes/Assumptions

- We will not handle uploads in this iteration; `icon_url` is a string placeholder.
- We will not port all Rails routes now; we’ll build parity incrementally, starting with puzzles and auth.
- Later iterations can add Queues, R2, and broader API coverage.

### To-dos

- [ ] Add D1 DB binding in wrangler.jsonc and typings
- [ ] Install drizzle-orm, @hono/zod-openapi, zod, jose, cookie utils
- [ ] Create Drizzle D1 schema and migrations
- [ ] Seed dev D1 with admin user and sample puzzles
- [ ] Implement JWT and cookie helpers (create/verify; set/clear)
- [ ] Add Hono routes for admin sign_in/sign_out/me (cookie)
- [ ] Add Hono routes for player sign_in/sign_up/guest/me
- [ ] Add requireAdmin and requirePlayer middleware
- [ ] Configure zod/OpenAPI and /api-docs route
- [ ] Implement /api/puzzles/daily and /api/puzzles/:id
- [ ] Create /login page with form and redirect on success
- [ ] Add protected /admin layout and sign out
- [ ] Create /admin/daily/puzzles SSR page